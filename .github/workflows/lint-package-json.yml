name: lint-package-json

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: '18.x'
        description: 'Node.js version to use'
      working-directory:
        required: false
        type: string
        default: '.'
        description: 'Directory that contains package.json'

jobs:
  lint-package-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Generate npm-package-json-lint config (Decentraland standard)
        working-directory: ${{ inputs.working-directory }}
        shell: bash
        run: |
          node - <<'NODE'
          const fs = require('fs')
          const path = require('path')
          
          function safeReadJson(filePath) {
            try {
              return JSON.parse(fs.readFileSync(filePath, 'utf8'))
            } catch {
              return null
            }
          }
          
          function getInternalPackageExceptions(pkgJsonSection) {
            if (!pkgJsonSection || typeof pkgJsonSection !== 'object') return []
          
            return Object.keys(pkgJsonSection).filter(
              (name) => name.startsWith('@dcl/') || name.startsWith('decentraland-')
            )
          }
          
          function getPreferAbsoluteRule(severity, exceptions) {
            return exceptions.length > 0 ? [severity, { exceptions }] : severity
          }
          
          const pkgJson = safeReadJson(path.join(process.cwd(), 'package.json'))
          
          const config = {
            rules: {
              // Dependency Management Standard:
              // - deps/devDeps must be exact
              // - exception: internal Decentraland packages may use ranges (^)
              'prefer-absolute-version-dependencies': getPreferAbsoluteRule(
                'warning',
                getInternalPackageExceptions(pkgJson?.dependencies)
              ),
              'prefer-absolute-version-devDependencies': getPreferAbsoluteRule(
                'warning',
                getInternalPackageExceptions(pkgJson?.devDependencies)
              ),
              'no-file-dependencies': 'error',
              'no-git-dependencies': 'error',
              'no-duplicate-properties': 'error',
              'prefer-property-order': [
                'error',
                [
                  'name',
                  'version',
                  'description',
                  'main',
                  'module',
                  'types',
                  'type',
                  'exports',
                  'files',
                  'scripts',
                  'dependencies',
                  'peerDependencies',
                  'peerDependenciesMeta',
                  'devDependencies',
                  'repository',
                  'keywords',
                  'author',
                  'license',
                  'bugs',
                  'homepage',
                  'engines',
                  'overrides',
                  'publishConfig'
                ]
              ]
            }
          }
          
          fs.writeFileSync('.npmpackagejsonlintrc.json', JSON.stringify(config, null, 2) + '\n')
          console.log('Generated .npmpackagejsonlintrc.json')
          NODE

      - name: Lint package.json
        working-directory: ${{ inputs.working-directory }}
        run: |
          npx --yes npm-package-json-lint@9 .
          echo "âœ… package.json lint passed"

